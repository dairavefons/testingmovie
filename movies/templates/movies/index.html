{% extends 'base.html' %}
{% block content %}
{% load static %}
<div class="p-3">
    <div class="container">
        <div class="row mt-3">
            <div class="col mx-auto mb-3">
                <h2>List of Movies</h2>
                <hr />
                <p class="card-text"></p>
                    <form method="GET">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-auto">
                                <div class="input-group col-auto">
                                    <div class="input-group-text">Search</div>
                                    <input type="text" class="form-control" name="search">
                                </div>
                            </div>
                            <div class="col-auto">
                                <button class="btn bg-dark text-white" type="submit">Search</button>
                            </div>
                            <div class="col-auto">
                                <a href="{% url 'movies.hidden' %}" class="btn btn-outline-secondary">View Hidden Movies</a>
                            </div>
                            <div class="col-auto">
                                <a href="{% url 'movies.petition' %}" class="btn btn-outline-primary">Movie Petition</a>
                            </div>
                        </div>
                    </form>
                </p>

            </div>
        </div>
        <div class="row">
            {% for movie in template_data.movies %}
            <div class="col-md-4 col-lg-3 mb-2">
                <div class="p-2 card align-items-center pt-4">
                    <img src="{{ movie.image.url}}"
                         class="card-img-top rounded img-card-200">
                    <div class="card-body text-center">
                        <a href="{% url 'movies.show' id=movie.id %}"
                            class="btn bg-dark text-white">
                            {{ movie.name }}
                        </a>
                        <h5 class="card-title">{{ movie.name }}</h5>
                        <p class="card-text">${{ movie.price }}</p>
                        <p class="card-text">{{ movie.description }}</p>
                        {% if user.is_authenticated %}
                        <div class="d-flex justify-content-between align-items-center">
                            <button class="btn btn-outline-danger btn-sm like-btn"
                                    data-movie-id="{{ movie.id }}"
                                    data-liked="{{ movie.user_liked|yesno:'true,false' }}">
                                <span class="like-icon">{% if movie.user_liked %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span>
                                <span class="like-count">{{ movie.like_count }}</span>
                            </button>
                            <a href="{% url 'movies.hide' id=movie.id %}"
                               class="btn btn-warning btn-sm">Hide</a>
                        </div>
                        {% else %}
                        <div class="d-flex justify-content-center">
                            <span class="text-muted">
                                <span>ü§ç</span>
                                <span>{{ movie.like_count }}</span>
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    const likeButtons = document.querySelectorAll('.like-btn');
    const csrfToken = getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value;

    likeButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();

            const movieId = this.dataset.movieId;
            const likeIcon = this.querySelector('.like-icon');
            const likeCount = this.querySelector('.like-count');

            console.log('Clicking like for movie:', movieId);
            console.log('CSRF Token:', csrfToken);

            fetch(`/movies/${movieId}/like/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`HTTP error! status: ${response.status}, response: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Like response data:', data);
                likeIcon.textContent = data.liked ? '‚ù§Ô∏è' : 'ü§ç';
                likeCount.textContent = data.like_count;
                this.dataset.liked = data.liked.toString();

                // Update button appearance
                if (data.liked) {
                    this.classList.remove('btn-outline-danger');
                    this.classList.add('btn-danger');
                } else {
                    this.classList.remove('btn-danger');
                    this.classList.add('btn-outline-danger');
                }
            })
            .catch(error => {
                console.error('Error liking movie:', error);
                alert('Error liking movie: ' + error.message);
            });
        });
    });
});
</script>
{% endblock content %}